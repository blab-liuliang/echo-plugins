///////////////////////////////////////////////////////////////////////////////
/// \file template_arity.hpp
/// Replace all nodes stored by reference by nodes stored by value.
//
//  Copyright 2011 Eric Niebler. Distributed under the Boost
//  Software License, Version 1.0. (See accompanying file
//  LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
//
//  This file is based on a similar one in MPL from Aleksey Gurtovoy.

#ifndef HBOOST_PROTO_DETAIL_TEMPLATE_ARITY_HPP_EAN_2011_05_07
#define HBOOST_PROTO_DETAIL_TEMPLATE_ARITY_HPP_EAN_2011_05_07

// Somewhat indirect definition of HBOOST_PROTO_TEMPLATE_ARITY_PARAM is
// to overcome a shortcoming of the Wave tool used to generate the
// pre-preprocessed headers.
#define HBOOST_PROTO_TEMPLATE_ARITY_PARAM HBOOST_PROTO_TEMPLATE_ARITY_PARAM2
#define HBOOST_PROTO_TEMPLATE_ARITY_PARAM2(param)

#if defined(HBOOST_PROTO_EXTENDED_TEMPLATE_PARAMETERS_MATCHING) ||                                   \
  (defined(__WAVE__) && defined(HBOOST_PROTO_CREATE_PREPROCESSED_FILES))

#include <hboost/preprocessor/cat.hpp>
#include <hboost/preprocessor/inc.hpp>
#include <hboost/preprocessor/iteration/iterate.hpp>
#include <hboost/preprocessor/repetition/enum_params.hpp>
#include <hboost/mpl/int.hpp>
#include <hboost/proto/proto_fwd.hpp>

#undef HBOOST_PROTO_TEMPLATE_ARITY_PARAM2
#define HBOOST_PROTO_TEMPLATE_ARITY_PARAM2(param) , param

namespace hboost { namespace proto { namespace detail
{
    sized_type<1>::type template_arity_helper(...);

    // Other overloads generated by the preprocessor
    #include <hboost/proto/detail/template_arity_helper.hpp>

    template<typename F, int N, int Size>
    struct template_arity_impl2
      : mpl::int_<Size - 1>
    {};

    template<typename F, int N = HBOOST_PROTO_MAX_ARITY>
    struct template_arity
      : template_arity_impl2<
            F
          , N
          , sizeof(detail::template_arity_helper((F **)0, (mpl::int_<N> *)0))
        >
    {};

    template<typename F, int N>
    struct template_arity_impl2<F, N, 1>
      : template_arity<F, N-1>
    {};

    template<typename F>
    struct template_arity_impl2<F, 0, 1>
      : mpl::int_<-1>
    {};

}}}

#endif // HBOOST_PROTO_EXTENDED_TEMPLATE_PARAMETERS_MATCHING
#endif // HBOOST_PROTO_DETAIL_TEMPLATE_ARITY_HPP_EAN_2011_05_07
